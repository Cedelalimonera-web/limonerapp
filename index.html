<script>
/* ========= INSUMOS ========= */
let insumos = JSON.parse(localStorage.getItem("insumos")) || [];

insumos = insumos.filter(i => i && i.nombre);
insumos = insumos.map(i => ({
  nombre: i.nombre,
  stock: Number(i.stock) || 0
}));
localStorage.setItem("insumos", JSON.stringify(insumos));

function renderInsumos() {
  const lista = document.getElementById("listaInsumos");
  lista.innerHTML = "";

  insumos.forEach((insumo, index) => {
    lista.innerHTML += `
      <div class="card">
        <strong>${insumo.nombre}</strong>
        <span>${insumo.stock}</span>
        <div class="acciones">
          <button onclick="usarInsumo(${index})">âˆ’ Usar</button>
          <button onclick="eliminarInsumo(${index})">ğŸ—‘ï¸</button>
        </div>
      </div>
    `;
  });
}

function agregarInsumo() {
  const nombre = prompt("Nombre del insumo:");
  if (!nombre) return;

  const stock = Number(prompt("Stock inicial:")) || 0;
  insumos.push({ nombre, stock });

  localStorage.setItem("insumos", JSON.stringify(insumos));
  renderInsumos();
}

function usarInsumo(index) {
  if (insumos[index].stock > 0) {
    insumos[index].stock--;
    localStorage.setItem("insumos", JSON.stringify(insumos));
    renderInsumos();
  }
}

function eliminarInsumo(index) {
  if (confirm("Â¿Eliminar insumo?")) {
    insumos.splice(index, 1);
    localStorage.setItem("insumos", JSON.stringify(insumos));
    renderInsumos();
  }
}

/* ========= TAREAS ========= */
let tareas = JSON.parse(localStorage.getItem("tareas")) || [];

function renderTareas() {
  const lista = document.getElementById("listaTareas");
  lista.innerHTML = "";

  tareas.forEach((t, index) => {
    lista.innerHTML += `
      <div class="card">
        <strong style="text-decoration:${t.hecha ? 'line-through' : 'none'}">
          ${t.texto}
        </strong>
        <small>
          ${t.insumo ? `â†’ ${t.insumo} (${t.cantidad})` : ""}
        </small>
        <div class="acciones">
          <button onclick="toggleTarea(${index})">
            ${t.hecha ? 'â†©ï¸' : 'âœ…'}
          </button>
          <button onclick="eliminarTarea(${index})">ğŸ—‘ï¸</button>
        </div>
      </div>
    `;
  });
}

function agregarTarea() {
  const texto = prompt("DescripciÃ³n de la tarea:");
  if (!texto) return;

  let insumo = null;
  let cantidad = 0;

  if (insumos.length > 0 && confirm("Â¿Esta tarea usa insumos?")) {
    const nombres = insumos.map(i => i.nombre).join(", ");
    insumo = prompt("Insumo a usar:\n" + nombres);
    cantidad = Number(prompt("Cantidad a usar:")) || 0;
  }

  tareas.push({
    texto,
    hecha: false,
    insumo,
    cantidad
  });

  localStorage.setItem("tareas", JSON.stringify(tareas));
  renderTareas();
}

function toggleTarea(index) {
  const tarea = tareas[index];

  if (!tarea.hecha && tarea.insumo && tarea.cantidad > 0) {
    const insumo = insumos.find(i => i.nombre === tarea.insumo);
    if (insumo) {
      if (insumo.stock < tarea.cantidad) {
        alert("Stock insuficiente");
        return;
      }
      insumo.stock -= tarea.cantidad;
    }
  }

  tarea.hecha = !tarea.hecha;
  localStorage.setItem("insumos", JSON.stringify(insumos));
  localStorage.setItem("tareas", JSON.stringify(tareas));
  renderInsumos();
  renderTareas();
}

function eliminarTarea(index) {
  if (confirm("Â¿Eliminar tarea?")) {
    tareas.splice(index, 1);
    localStorage.setItem("tareas", JSON.stringify(tareas));
    renderTareas();
  }
}

/* ========= INIT ========= */
renderInsumos();
renderTareas();
</script>
